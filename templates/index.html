{% extends "base.html" %}
{% block title %}Fishing Predictor Pro - Dashboard{% endblock %}
{% block extra_css %}
<style>
body{background:linear-gradient(135deg,#0f172a 0%,#1e293b 100%);color:#f8fafc;min-height:100vh;padding:1rem}
.container{max-width:1400px;margin:0 auto;padding:0 1rem}
header{text-align:center;padding:1.5rem 0;margin-bottom:1.5rem;border-bottom:2px solid #334155;position:relative}
h1{font-size:2.5rem;background:linear-gradient(90deg,#3b82f6,#10b981);-webkit-background-clip:text;background-clip:text;color:transparent;margin-bottom:.5rem}
.subtitle{color:#94a3b8;font-size:1.1rem}

/* Structure √† 2 colonnes √©quilibr√©es */
.dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:2rem}
@media (max-width:1024px){.dashboard-grid{grid-template-columns:1fr}}

.left-column,.right-column{display:flex;flex-direction:column;gap:1.5rem}

.card{background:rgba(30,41,59,.9);backdrop-filter:blur(10px);border-radius:16px;padding:1.5rem;border:1px solid #475569;box-shadow:0 10px 25px rgba(0,0,0,.3)}
.section-title{display:flex;align-items:center;gap:.75rem;font-size:1.5rem;font-weight:700;margin-bottom:1.5rem;color:#e2e8f0}
#map{width:100%;height:450px;border-radius:12px;overflow:hidden;position:relative}
.info-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:1.5rem}
.score-display{text-align:center;padding:2rem;background:linear-gradient(135deg,rgba(30,41,59,.9),rgba(15,23,42,.9));border-radius:16px;margin:1rem 0;border:2px solid #475569}
.score-value{font-size:5rem;font-weight:900;background:linear-gradient(90deg,#10b981,#3b82f6);-webkit-background-clip:text;background-clip:text;color:transparent;line-height:1}
.btn{padding:.75rem 1.5rem;border-radius:8px;border:none;font-weight:600;cursor:pointer;transition:all .3s ease}
.btn-primary{background:linear-gradient(90deg,#3b82f6,#2563eb);color:white}
.btn-secondary{background:rgba(255,255,255,.1);color:white;border:1px solid #475569}
.btn-danger{background:#dc2626;color:white;border:none}
.btn-danger:hover{background:#b91c1c;transform:translateY(-2px);box-shadow:0 5px 15px rgba(220,38,38,0.3)}
.btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(0,0,0,.3)}

@media (max-width:768px){
    h1{font-size:1.8rem}
    .dashboard-grid{grid-template-columns:1fr;gap:1rem}
    #map{height:350px}
    .score-value{font-size:3.5rem}
    .info-grid{grid-template-columns:1fr 1fr}
}

@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.5}}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes slideOut{from{transform:translateX(0);opacity:1}to{transform:translateX(100%);opacity:0}}

.spot-card{transition:all .3s ease;cursor:pointer;border-radius:8px;overflow:hidden}
.spot-card:hover{transform:translateY(-4px);box-shadow:0 10px 25px rgba(0,0,0,.15);border-color:#3b82f6}
.status-indicator{display:inline-flex;align-items:center;gap:.5rem;padding:.5rem 1rem;border-radius:20px;font-weight:600;font-size:.9rem}
.status-good{background:#d1fae5;color:#065f46;border:2px solid #10b981}
.status-warning{background:#fef3c7;color:#92400e;border:2px solid #f59e0b}
.status-danger{background:#fee2e2;color:#991b1b;border:2px solid #ef4444;animation:pulse 2s infinite}

.spot-details-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.75rem;margin-top:1rem}
.detail-item{text-align:center;padding:.75rem;background:rgba(51,65,85,.6);border-radius:8px;border:1px solid #475569}
.detail-icon{font-size:1.5rem;margin-bottom:.5rem}
.detail-value{font-size:1rem;font-weight:700;color:#f8fafc;margin-bottom:.25rem}
.detail-label{font-size:.75rem;color:#94a3b8}

/* Graphique */
.chart-container{position:relative;height:200px;margin:1rem 0}

/* M√©t√©o compacte */
.compact-weather-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem}
.weather-item{display:flex;flex-direction:column;align-items:center;padding:1rem;background:rgba(51,65,85,.6);border-radius:12px}
.weather-icon{font-size:2rem;margin-bottom:.5rem}
.weather-value{font-size:1.8rem;font-weight:700;color:#f8fafc;line-height:1}
.weather-label{font-size:.8rem;color:#94a3b8;margin-top:.25rem}

/* Score header compact */
.header-score{background:rgba(30,41,59,.95);border-radius:12px;padding:1rem 1.5rem;border:2px solid #475569;min-width:200px;text-align:center}
.header-score-value{font-size:2.5rem;font-weight:900;background:linear-gradient(90deg,#10b981,#3b82f6);-webkit-background-clip:text;background-clip:text;color:transparent;line-height:1}
.header-score-label{color:#94a3b8;font-size:.9rem}

/* D√©tails scientifiques */
.scientific-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;margin-top:1rem}
.scientific-item{text-align:center;padding:1rem;background:rgba(51,65,85,.6);border-radius:12px}
.scientific-icon{font-size:1.8rem}
.scientific-value{font-size:1.2rem;font-weight:700;margin:.5rem 0;color:#f8fafc}
.scientific-label{font-size:.75rem;color:#94a3b8}

/* Analyse d√©taill√©e */
.details-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;margin-top:1.5rem}
.detail-card{padding:1rem;background:rgba(51,65,85,.6);border-radius:8px;border-left:4px solid #3b82f6}
.detail-card h4{margin:0 0 .5rem 0;color:#cbd5e1;font-size:.9rem;display:flex;align-items:center;gap:.5rem}
.detail-value-large{font-size:1.25rem;font-weight:700;color:#f8fafc}
.detail-value-small{font-size:.85rem;color:#94a3b8}

footer{text-align:center;padding:2rem 0;color:#94a3b8;border-top:1px solid #334155;margin-top:2rem}
</style>
{% endblock %}

{% block content %}
<div id="offshore-danger" style="display:none;position:fixed;top:0;left:0;right:0;background:#dc2626;color:white;padding:1rem;z-index:9999;text-align:center;animation:blink 1s infinite">
    <div style="display:flex;align-items:center;justify-content:center;gap:1rem">
        <i class="fas fa-skull-crossbones" style="font-size:1.5rem"></i>
        <div>
            <div style="font-weight:700;font-size:1.2rem">‚ö†Ô∏è DANGER VENT OFFSHORE</div>
            <div style="font-size:.9rem">NE P√äCHEZ PAS - Risque de noyade tr√®s √©lev√©</div>
        </div>
        <i class="fas fa-skull-crossbones" style="font-size:1.5rem"></i>
    </div>
</div>

<div class="container">
    <!-- Header compact -->
    <header>
        <div style="display:flex;justify-content:space-between;align-items:center;padding:0 1rem">
            <div>
                <h1><i class="fas fa-fish"></i> Fishing Predictor Pro</h1>
                <div class="subtitle">Dashboard temps r√©el ‚Ä¢ Tunisie</div>
            </div>
            <div class="header-score">
                <div class="header-score-value" id="header-prediction-score">--%</div>
                <div class="header-score-label" id="header-prediction-text">Chargement...</div>
            </div>
            <div style="display:flex;gap:1rem;align-items:center">
                <div class="status-indicator status-good" style="animation:pulse 2s infinite">
                    <i class="fas fa-satellite-dish"></i> R√âEL
                </div>
                <div style="background:rgba(0,0,0,.7);color:white;padding:.5rem 1rem;border-radius:20px;font-size:.8rem">
                    <i class="fas fa-hourglass-half"></i> <span id="countdown">30:00</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Banni√®re d√©cision instantan√©e -->
    <div id="instant-decision-banner" style="margin-bottom:1.5rem"></div>

    <!-- Grille principale √† 2 colonnes √©quilibr√©es -->
    <div class="dashboard-grid">
        
        <!-- COLONNE GAUCHE -->
        <div class="left-column">
            
            <!-- Carte avec bouton effacer -->
            <div class="card">
                <div class="section-title">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <i class="fas fa-map"></i>
                    </div>
                    Carte des spots
                    <div style="margin-left:auto;font-size:.8rem;color:#94a3b8">
                        <i class="fas fa-mouse-pointer"></i> Cliquez pour cr√©er
                    </div>
                </div>
                
                <div style="position:relative">
                    <!-- Filtres rapides -->
                    <div style="position:absolute;top:10px;right:15px;z-index:1000">
                        <div style="background:rgba(0,0,0,.8);backdrop-filter:blur(10px);padding:12px;border-radius:12px;border:1px solid #475569">
                            <div style="display:flex;gap:12px">
                                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;color:white;font-size:12px">
                                    <input type="checkbox" checked onchange="window.FishingDashboard.toggleSpotType('port')">
                                    <i class="fas fa-anchor" style="color:#3b82f6"></i> Ports
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;color:white;font-size:12px">
                                    <input type="checkbox" checked onchange="window.FishingDashboard.toggleSpotType('plage')">
                                    <i class="fas fa-umbrella-beach" style="color:#10b981"></i> Plages
                                </label>
                                <label style="display:flex;align-items:center;gap:4px;cursor:pointer;color:white;font-size:12px">
                                    <input type="checkbox" checked onchange="window.FishingDashboard.toggleSpotType('custom')">
                                    <i class="fas fa-map-pin" style="color:#ef4444"></i> Mes spots
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div id="map"></div>
                    <canvas id="wind-animation-canvas" style="position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:500;display:none"></canvas>
                </div>
                
                <div style="display:flex;justify-content:space-between;margin-top:1rem;flex-wrap:wrap;gap:.5rem">
                    <button id="windToggleBtn" onclick="window.FishingDashboard.toggleWindAnimation(event)" class="btn btn-secondary">
                        <i class="fas fa-wind"></i> Afficher vent
                    </button>
                    <button onclick="window.FishingDashboard.getCurrentLocation()" class="btn btn-secondary">
                        <i class="fas fa-location-dot"></i> Ma position
                    </button>
                    <button onclick="window.FishingDashboard.saveCurrentSpot()" class="btn btn-primary">
                        <i class="fas fa-save"></i> Sauvegarder
                    </button>
                    <button onclick="window.FishingDashboard.clearCustomSpots()" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Effacer mes spots
                    </button>
                </div>
            </div>
            
            <!-- Score principal et v√©rification express -->
            <div class="card">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;align-items:center">
                    <div class="score-display" style="margin:0">
                        <div class="score-value" id="prediction-score">--%</div>
                        <div id="prediction-text" style="font-size:1.1rem;margin-top:.5rem;color:#94a3b8">Chargement...</div>
                        <button onclick="window.FishingDashboard.quickCheck()" class="btn btn-primary" style="margin-top:1rem;width:100%">
                            <i class="fas fa-bolt"></i> V√©rification express
                        </button>
                    </div>
                    <div style="text-align:center">
                        <div style="font-size:4rem;background:linear-gradient(90deg,#3b82f6,#10b981);-webkit-background-clip:text;background-clip:text;color:transparent">
                            <i class="fas fa-fish"></i>
                        </div>
                        <div style="font-size:1.5rem;font-weight:700;color:#f8fafc" id="current-fish-count">--</div>
                        <div style="color:#94a3b8;font-size:.9rem">Poissons actifs estim√©s</div>
                    </div>
                </div>
            </div>
            
            <!-- Spot s√©lectionn√© + Distance -->
            <div class="card">
                <div class="section-title">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    Spot s√©lectionn√©
                </div>
                <div id="spot-info" style="padding:1rem;background:#1e293b;border-radius:8px;margin-bottom:1rem">
                    <div style="text-align:center;color:#94a3b8">
                        <i class="fas fa-map-marker-alt" style="font-size:2rem;margin-bottom:.5rem"></i>
                        <div>S√©lectionnez un spot sur la carte</div>
                    </div>
                </div>
                <div id="distance-info" style="margin-bottom:1rem"></div>
                <button onclick="window.FishingDashboard.calculatePreparationTime()" class="btn btn-secondary" style="width:100%">
                    <i class="fas fa-clock"></i> Temps de pr√©paration
                </button>
            </div>
            
            <!-- Donn√©es scientifiques compactes -->
            <div class="card">
                <div class="section-title">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <i class="fas fa-flask"></i>
                    </div>
                    Donn√©es scientifiques
                </div>
                <div class="scientific-grid">
                    <div class="scientific-item">
                        <div class="scientific-icon">üå°Ô∏è</div>
                        <div class="scientific-value" id="water-temp">--¬∞C</div>
                        <div class="scientific-label">Eau</div>
                    </div>
                    <div class="scientific-item">
                        <div class="scientific-icon">üíß</div>
                        <div class="scientific-value" id="oxygen-level">-- mg/L</div>
                        <div class="scientific-label">Oxyg√®ne</div>
                    </div>
                    <div class="scientific-item">
                        <div class="scientific-icon">üåø</div>
                        <div class="scientific-value" id="phytoplankton">--</div>
                        <div class="scientific-label">Phytoplancton</div>
                    </div>
                    <div class="scientific-item">
                        <div class="scientific-icon">üåä</div>
                        <div class="scientific-value" id="wave-height">-- m</div>
                        <div class="scientific-label">Vagues</div>
                    </div>
                    <div class="scientific-item">
                        <div class="scientific-icon">üåô</div>
                        <div class="scientific-value" id="moon-phase">--</div>
                        <div class="scientific-label">Lune</div>
                    </div>
                    <div class="scientific-item">
                        <div class="scientific-icon">üé£</div>
                        <div class="scientific-value" id="best-period">--h</div>
                        <div class="scientific-label">Meilleur</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- COLONNE DROITE -->
        <div class="right-column">
            
            <!-- M√©t√©o compacte -->
            <div class="card">
                <div class="section-title">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <i class="fas fa-cloud-sun"></i>
                    </div>
                    M√©t√©o actuelle
                </div>
                <div class="compact-weather-grid">
                    <div class="weather-item">
                        <div class="weather-icon"><i class="fas fa-wind"></i></div>
                        <div class="weather-value" id="wind-speed">--</div>
                        <div class="weather-label" id="wind-direction">Direction</div>
                    </div>
                    <div class="weather-item">
                        <div class="weather-icon"><i class="fas fa-temperature-half"></i></div>
                        <div class="weather-value" id="temperature">--¬∞C</div>
                        <div class="weather-label">Air</div>
                    </div>
                    <div class="weather-item">
                        <div class="weather-icon"><i class="fas fa-water"></i></div>
                        <div class="weather-value" id="pressure">-- hPa</div>
                        <div class="weather-label">Pression</div>
                    </div>
                    <div class="weather-item">
                        <div class="weather-icon"><i class="fas fa-cloud"></i></div>
                        <div class="weather-value" id="weather-condition">--</div>
                        <div class="weather-label" id="cloud-cover">Nuages</div>
                    </div>
                </div>
                
                <!-- √âl√©ments cach√©s pour compatibilit√© -->
                <div style="display:none">
                    <div id="weather-location-name"></div>
                    <div id="weather-icon"></div>
                    <div id="wind-impact"></div>
                    <div id="wind-fishing-tips"></div>
                    <div id="weather-updated"></div>
                    <div id="weather-pressure"></div>
                </div>
                
                <div id="wind-offshore-alert" style="display:none;margin-top:1rem;padding:1rem;background:#ef4444;color:white;border-radius:8px;text-align:center;animation:pulse 1.5s infinite">
                    <i class="fas fa-exclamation-triangle"></i> <strong>VENT OFFSHORE - DANGER DE NOYADE</strong>
                </div>
            </div>
            
            <!-- Graphique activit√© 24h -->
            <div class="card">
                <div class="section-title">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    Activit√© sur 24h
                </div>
                <div class="chart-container">
                    <canvas id="activity-chart"></canvas>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;margin-top:1rem">
                    <div style="text-align:center;padding:.75rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.8rem">Tendance</div>
                        <div style="display:flex;align-items:center;justify-content:center;gap:.5rem;margin-top:.25rem">
                            <span id="trend-arrow" style="font-size:1.5rem">‚ÜóÔ∏è</span>
                            <span id="current-trend" style="font-weight:700">--</span>
                        </div>
                    </div>
                    <div style="text-align:center;padding:.75rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.8rem">Meilleur moment</div>
                        <div style="font-size:1.5rem;font-weight:700;margin-top:.25rem" id="next-window-start">--:--</div>
                        <div style="font-size:.9rem;color:#3b82f6" id="next-window-end"></div>
                        <div style="font-size:.75rem;color:#94a3b8;margin-top:.25rem">
                            <span id="window-quality">--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Analyse d√©taill√©e -->
            <div class="card">
                <div class="section-title">
                    <div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    Analyse d√©taill√©e
                    <button onclick="window.FishingDashboard.toggleDetailedAnalysis()" style="margin-left:auto;background:#3b82f6;color:white;border:none;padding:.4rem .8rem;border-radius:6px;font-size:.8rem;cursor:pointer">
                        <i class="fas fa-chevron-down"></i> Voir
                    </button>
                </div>
                
                <div id="detailed-analysis-mini" style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem">
                    <div style="padding:1rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.8rem">Score env.</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#3b82f6" id="mini-env-score">--%</div>
                    </div>
                    <div style="padding:1rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.8rem">Score comp.</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#10b981" id="mini-beh-score">--%</div>
                    </div>
                    <div style="padding:1rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.8rem">Profondeur</div>
                        <div style="font-size:1.5rem;font-weight:700;color:#f59e0b" id="mini-depth">-- m</div>
                    </div>
                    <div style="padding:1rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.8rem">Fond</div>
                        <div style="font-size:1.2rem;font-weight:700;color:#f59e0b" id="mini-seabed">--</div>
                    </div>
                </div>
                
                <div id="detailed-analysis-full" style="display:none;margin-top:1.5rem">
                    <div class="details-grid">
                        <div class="detail-card">
                            <h4><i class="fas fa-leaf"></i> Environnemental</h4>
                            <div class="detail-value-large" id="detail-environmental">--%</div>
                            <div class="detail-value-small">Qualit√© du milieu</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-fish"></i> Comportemental</h4>
                            <div class="detail-value-large" id="detail-behavioral">--%</div>
                            <div class="detail-value-small">Activit√© de l'esp√®ce</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-ruler-vertical"></i> Profondeur</h4>
                            <div class="detail-value-large" id="detail-depth">-- m</div>
                            <div class="detail-value-small" id="detail-depth-optimal">--</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-layer-group"></i> Type de fond</h4>
                            <div class="detail-value-large" id="detail-seabed">--</div>
                            <div class="detail-value-small">Nature du sol</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-water"></i> Hauteur vagues</h4>
                            <div class="detail-value-large" id="detail-wave-height">-- m</div>
                            <div class="detail-value-small">√âtat de la mer</div>
                        </div>
                        <div class="detail-card">
                            <h4><i class="fas fa-tachometer-alt"></i> Courant</h4>
                            <div class="detail-value-large" id="detail-current">-- m/s</div>
                            <div class="detail-value-small" id="detail-current-impact">--</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Check-list -->
            <div class="card">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <div class="section-title" style="margin-bottom:0">
                        <div style="width:40px;height:40px;background:linear-gradient(135deg,#3b82f6,#8b5cf6);border-radius:10px;display:flex;align-items:center;justify-content:center">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        Check-list
                    </div>
                    <span id="checklist-score" style="padding:.5rem 1rem;background:#1e293b;border-radius:20px;font-weight:700"></span>
                </div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;margin-top:1rem">
                    <div style="text-align:center;padding:.75rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.7rem">Vent offshore</div>
                        <div style="font-size:1.5rem;font-weight:700" id="check-offshore">‚ùå</div>
                    </div>
                    <div style="text-align:center;padding:.75rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.7rem">Score actuel</div>
                        <div style="font-size:1.5rem;font-weight:700" id="check-score">--%</div>
                    </div>
                    <div style="text-align:center;padding:.75rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.7rem">Heure</div>
                        <div style="font-size:1.5rem;font-weight:700" id="check-hour">--h</div>
                    </div>
                    <div style="text-align:center;padding:.75rem;background:#1e293b;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.7rem">Vagues</div>
                        <div style="font-size:1.5rem;font-weight:700" id="check-waves">-- m</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Footer -->
    <footer>
        <div>Fishing Predictor Pro ¬© 2026 ‚Ä¢ Donn√©es m√©t√©o temps r√©el</div>
        <div style="font-size:.8rem;margin-top:.5rem;color:#64748b">
            <i class="fas fa-satellite"></i> Vent synchronis√© avec WEkEO / Open-Meteo
        </div>
    </footer>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Fishing Dashboard Object - VERSION CORRIG√âE AVEC S√âPARATION DES POSITIONS
const FishingDashboard = (function() {
    // ========== VARIABLES PRIV√âES ==========
    let map = null;
    let userLat = 36.8065;        // Position de l'utilisateur (point de d√©part)
    let userLon = 10.1815;
    let currentMarker = null;      // Marqueur de l'utilisateur
    let selectedSpot = null;       // Spot s√©lectionn√© (point d'arriv√©e)
    let windAnimationActive = false;
    let windCanvas = null;
    let windCtx = null;
    let windParticles = [];
    let windAnimationFrame = null;
    let activityChart = null;
    let customSpots = [];
    let currentPredictionData = null;
    let currentWindDirection = 0;
    let currentWindSpeed = 10;
    
    // Spots tunisiens
    const TUNISIAN_SPOTS = [
        {name:"Tunis Marina",lat:36.8065,lon:10.1815,type:"port",depth:"8-12m",description:"Port de plaisance"},
        {name:"Cap Bon",lat:36.8475,lon:11.0940,type:"rocheux",depth:"15-25m",description:"Zone rocheuse"},
        {name:"Sousse",lat:35.8254,lon:10.6360,type:"port",depth:"6-10m",description:"Port de p√™che"},
        {name:"Hammamet Nord",lat:36.4000,lon:10.6000,type:"plage",depth:"5-8m",description:"Plage de sable"},
        {name:"Bizerte",lat:37.2747,lon:9.8739,type:"port",depth:"10-18m",description:"Canal"}
    ];
    
    // ========== FONCTIONS PRIV√âES ==========
    
    // --- FONCTION DE CALCUL DE LA HAUTEUR DES VAGUES ---
    function calculateWaveHeight(windSpeedKmh) {
        if (windSpeedKmh === undefined || windSpeedKmh === null) return 0.2;
        
        if (windSpeedKmh < 10) return 0.2;
        else if (windSpeedKmh < 20) return 0.2 + (windSpeedKmh - 10) * 0.04;
        else if (windSpeedKmh < 30) return 0.6 + (windSpeedKmh - 20) * 0.06;
        else if (windSpeedKmh < 40) return 1.2 + (windSpeedKmh - 30) * 0.08;
        else if (windSpeedKmh < 50) return 2.0 + (windSpeedKmh - 40) * 0.10;
        else if (windSpeedKmh < 60) return 3.0 + (windSpeedKmh - 50) * 0.12;
        else return 4.2 + (windSpeedKmh - 60) * 0.15;
    }
    
    // --- FONCTION DE MISE √Ä JOUR DE LA HAUTEUR DES VAGUES ---
    function updateWaveHeight(value, source) {
        let waveValue = value;
        if (typeof waveValue === 'number') {
            waveValue = waveValue.toFixed(1);
        }
        console.log(`üåä Vague mise √† jour: ${waveValue}m (source: ${source})`);
        document.getElementById('wave-height').textContent = waveValue + ' m';
        document.getElementById('check-waves').textContent = waveValue + ' m';
        document.getElementById('detail-wave-height').textContent = waveValue + ' m';
    }
    
    // --- MISE √Ä JOUR DE LA POSITION UTILISATEUR ---
    function updateUserPosition(lat, lon) {
        userLat = lat;
        userLon = lon;
        if (currentMarker) {
            currentMarker.setLatLng([lat, lon]);
        }
        // Optionnel : recentrer la carte
        if (map) map.setView([lat, lon], map.getZoom());
        // Recalculer la distance si un spot est s√©lectionn√©
        if (selectedSpot) {
            calculateDistanceToSpot(selectedSpot.lat, selectedSpot.lon);
        }
        // Rafra√Æchir les donn√©es m√©t√©o pour la nouvelle position
        loadWeatherDataInternal();
        updatePredictionInternal();
        updateScientificDataInternal();
        load24hForecastInternal();
    }
    
    // --- CALCUL DE DISTANCE ---
    async function calculateDistanceToSpot(lat, lon) {
        try {
            const response = await fetch(`/api/distance_calculation?lat1=${userLat}&lon1=${userLon}&lat2=${lat}&lon2=${lon}`);
            const data = await response.json();
            if (data.status === 'success') {
                const distanceKm = parseFloat(data.distance_km);
                const travelTimeMinutes = data.travel_time_minutes || Math.round((distanceKm / 50) * 60);
                
                // Mettre √† jour l'affichage dans le bloc "Spot s√©lectionn√©"
                const spotDistanceEl = document.getElementById('spot-distance');
                if (spotDistanceEl) {
                    if (distanceKm < 0.1) {
                        spotDistanceEl.innerHTML = `<span style="color:#94a3b8">Vous √™tes ici</span>`;
                    } else {
                        spotDistanceEl.innerHTML = `${distanceKm.toFixed(1)} km<br><span style="font-size:.7rem">${formatTime(travelTimeMinutes)}</span>`;
                    }
                }
                
                // Mettre √† jour la zone d'info distance (sous la carte)
                const distanceInfo = document.getElementById('distance-info');
                if (distanceInfo) {
                    if (distanceKm < 0.1) {
                        distanceInfo.innerHTML = `<div style="color:#94a3b8;padding:.5rem;"><i class="fas fa-check-circle" style="color:#10b981"></i> Vous √™tes sur place</div>`;
                    } else {
                        distanceInfo.innerHTML = `
                            <div style="display:flex;align-items:center;gap:.5rem;background:#1e293b;padding:.5rem;border-radius:6px">
                                <i class="fas fa-route" style="color:#3b82f6"></i>
                                <div><span style="font-weight:600">${distanceKm.toFixed(1)} km</span> ‚Ä¢ ${formatTime(travelTimeMinutes)}</div>
                            </div>
                        `;
                    }
                }
            }
        } catch(error) {
            console.error('Erreur calcul distance:', error);
        }
    }
    
    // --- FORMATER LE TEMPS DE TRAJET ---
    function formatTime(minutes) {
        if (minutes < 60) return `${minutes} min`;
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return mins > 0 ? `${hours}h${mins}` : `${hours}h`;
    }
    
    // --- S√âLECTION D'UN SPOT ---
    async function selectSpot(lat, lon, name) {
        selectedSpot = { lat, lon, name };
        
        // Mettre √† jour l'affichage du spot
        const spotInfo = document.getElementById('spot-info');
        if (spotInfo) {
            spotInfo.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <h3 style="margin:0;color:#3b82f6">${name}</h3>
                        <div style="color:#94a3b8;font-size:.9rem;margin-top:.25rem">
                            ${lat.toFixed(4)}, ${lon.toFixed(4)}
                        </div>
                    </div>
                    <div style="background:#1e293b;padding:.5rem;border-radius:8px">
                        <div style="color:#94a3b8;font-size:.8rem">Distance</div>
                        <div style="font-weight:700" id="spot-distance">Calcul...</div>
                    </div>
                </div>
            `;
        }
        
        // Centrer la carte sur le spot
        if (map) map.setView([lat, lon], 13);
        
        // Calculer la distance par rapport √† la position utilisateur
        await calculateDistanceToSpot(lat, lon);
        
        // Charger les donn√©es pour ce spot (en passant les coordonn√©es)
        await loadWeatherDataInternal(lat, lon);
        await updatePredictionInternal(lat, lon);
        await updateScientificDataInternal(lat, lon);
        await load24hForecastInternal(lat, lon);
        
        // Fermer les popups √©ventuels
        if (map) map.closePopup();
        
        // Notification
        showNotification(`Spot "${name}" s√©lectionn√©`, 'success');
    }
    
    // --- ANIMATION VENT ---
    function initWindAnimation() {
        windCanvas = document.getElementById('wind-animation-canvas');
        if(!windCanvas) return;
        windCtx = windCanvas.getContext('2d');
        if(!windCtx) return;
        
        function resizeCanvas() {
            const mapDiv = document.getElementById('map');
            if(mapDiv && windCanvas) {
                windCanvas.width = mapDiv.clientWidth;
                windCanvas.height = mapDiv.clientHeight;
                initWindParticles();
            }
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
    }
    
    function initWindParticles() {
        if(!windCanvas) return;
        const count = Math.min(100, Math.floor(windCanvas.width * windCanvas.height / 1500));
        windParticles = [];
        for(let i = 0; i < count; i++) {
            windParticles.push({
                x: Math.random() * windCanvas.width,
                y: Math.random() * windCanvas.height,
                size: Math.random() * 2 + 1,
                speed: (Math.random() * 1.5 + 0.5) * (currentWindSpeed / 15 || 1),
                opacity: Math.random() * 0.4 + 0.2,
                life: Math.random() * 100
            });
        }
    }
    
    function animateWind() {
        if(!windAnimationActive || !windCtx || !windCanvas) return;
        
        windCtx.clearRect(0, 0, windCanvas.width, windCanvas.height);
        
        let windAngle = ((currentWindDirection + 90) * Math.PI / 180);
        
        windParticles.forEach(p => {
            p.x += Math.cos(windAngle) * p.speed;
            p.y += Math.sin(windAngle) * p.speed;
            
            const speedFactor = currentWindSpeed / 20;
            p.x += Math.cos(windAngle) * (p.speed * speedFactor);
            p.y += Math.sin(windAngle) * (p.speed * speedFactor);
            
            if(p.x > windCanvas.width + 10) p.x = -10;
            if(p.x < -10) p.x = windCanvas.width + 10;
            if(p.y > windCanvas.height + 10) p.y = -10;
            if(p.y < -10) p.y = windCanvas.height + 10;
            
            windCtx.save();
            windCtx.translate(p.x, p.y);
            windCtx.rotate(windAngle);
            
            windCtx.beginPath();
            windCtx.moveTo(0, 0);
            windCtx.lineTo(-8, -2);
            windCtx.lineTo(-8, 2);
            windCtx.closePath();
            
            windCtx.fillStyle = `rgba(59, 130, 246, ${p.opacity * 0.8})`;
            windCtx.fill();
            
            windCtx.beginPath();
            windCtx.arc(0, 0, p.size, 0, Math.PI * 2);
            windCtx.fillStyle = `rgba(59, 130, 246, ${p.opacity})`;
            windCtx.fill();
            
            windCtx.restore();
        });
        
        windAnimationFrame = requestAnimationFrame(animateWind);
    }
    
    // --- ALERTE VENT FORT ---
    function checkStrongWind(windSpeed) {
        const strongWindThreshold = 30;
        const veryStrongWindThreshold = 45;
        
        let strongWindAlert = document.getElementById('strong-wind-alert');
        if(!strongWindAlert) {
            strongWindAlert = document.createElement('div');
            strongWindAlert.id = 'strong-wind-alert';
            strongWindAlert.style.cssText = 'display:none;margin-top:1rem;padding:1rem;color:white;border-radius:8px;text-align:center;animation:pulse 1.5s infinite';
            
            const offshoreAlert = document.getElementById('wind-offshore-alert');
            if(offshoreAlert && offshoreAlert.parentNode) {
                offshoreAlert.parentNode.insertBefore(strongWindAlert, offshoreAlert.nextSibling);
            }
        }
        
        if(windSpeed >= veryStrongWindThreshold) {
            strongWindAlert.style.display = 'block';
            strongWindAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>VENT TR√àS FORT - DANGER</strong><br>P√™che d√©conseill√©e, risque de s√©curit√© √©lev√©';
            strongWindAlert.style.background = '#dc2626';
        } else if(windSpeed >= strongWindThreshold) {
            strongWindAlert.style.display = 'block';
            strongWindAlert.innerHTML = '<i class="fas fa-exclamation-triangle"></i> <strong>VENT FORT</strong><br>Conditions difficiles pour la p√™che, prudence recommand√©e';
            strongWindAlert.style.background = '#f59e0b';
        } else {
            if(strongWindAlert) strongWindAlert.style.display = 'none';
        }
    }
    
    // --- CHARGEMENT M√âT√âO (accepte des coordonn√©es optionnelles) ---
    async function loadWeatherDataInternal(lat = null, lon = null) {
        const targetLat = lat !== null ? lat : userLat;
        const targetLon = lon !== null ? lon : userLon;
        try {
            const response = await fetch(`/api/current_weather?lat=${targetLat}&lon=${targetLon}`);
            const data = await response.json();
            
            console.log('üì¶ Donn√©es m√©t√©o re√ßues:', data);
            
            if(data.status === 'success') {
                const weather = data.weather;
                
                currentWindDirection = weather.wind_direction || 0;
                currentWindSpeed = weather.wind_speed || 10;
                
                document.getElementById('temperature').textContent = `${weather.temperature?.toFixed(1) || '--'}¬∞C`;
                document.getElementById('wind-speed').textContent = `${weather.wind_speed?.toFixed(1) || '--'} km/h`;
                document.getElementById('wind-direction').textContent = weather.wind_direction_name || '--';
                document.getElementById('pressure').textContent = `${weather.pressure?.toFixed(0) || '--'} hPa`;
                document.getElementById('weather-condition').textContent = weather.condition_fr || '--';
                document.getElementById('cloud-cover').textContent = `Nuages: ${weather.clouds || '--'}%`;
                
                // Mise √† jour de la hauteur des vagues
                let waveValue = 0.2;
                if (weather.wave_height !== undefined && weather.wave_height !== null) {
                    waveValue = weather.wave_height;
                    updateWaveHeight(waveValue, 'API directe');
                } else if (weather.wind_speed) {
                    waveValue = calculateWaveHeight(weather.wind_speed);
                    updateWaveHeight(waveValue, 'calcul√© depuis vent');
                } else {
                    updateWaveHeight(waveValue, 'valeur par d√©faut');
                }
                
                if(document.getElementById('weather-location-name')) {
                    document.getElementById('weather-location-name').textContent = weather.location || '--';
                }
                if(document.getElementById('weather-icon')) {
                    document.getElementById('weather-icon').innerHTML = weather.icon ? 
                        `<img src="https://openweathermap.org/img/wn/${weather.icon}@2x.png" alt="${weather.condition_fr}">` : '';
                }
                if(document.getElementById('wind-impact')) {
                    document.getElementById('wind-impact').textContent = weather.wind_fishing_impact || '--';
                }
                if(document.getElementById('wind-fishing-tips')) {
                    document.getElementById('wind-fishing-tips').innerHTML = weather.wind_fishing_impact ? 
                        `<i class="fas fa-info-circle"></i> ${weather.wind_fishing_impact}` : '--';
                }
                if(document.getElementById('weather-updated')) {
                    document.getElementById('weather-updated').textContent = `Mis √† jour: ${new Date().toLocaleTimeString('fr-FR', {hour:'2-digit', minute:'2-digit'})}`;
                }
                if(document.getElementById('weather-pressure')) {
                    document.getElementById('weather-pressure').textContent = `${weather.pressure?.toFixed(0) || '--'} hPa`;
                }
                
                checkOffshoreWind(weather.wind_offshore);
                checkStrongWind(weather.wind_speed || 0);
                
                if(windAnimationActive) {
                    initWindParticles();
                }
                
                if(weather.wave_height) {
                    document.getElementById('wave-height').textContent = `${weather.wave_height.toFixed(1)} m`;
                    document.getElementById('check-waves').textContent = `${weather.wave_height.toFixed(1)} m`;
                    document.getElementById('detail-wave-height').textContent = `${weather.wave_height.toFixed(1)} m`;
                }
                
                console.log(`üå¨Ô∏è Vent synchronis√©: ${currentWindSpeed} km/h, direction: ${currentWindDirection}¬∞ (${weather.wind_direction_name})`);
            }
        } catch(error) {
            console.error('Erreur m√©t√©o:', error);
        }
        updatePredictionInternal(lat, lon);
    }
    
    // --- PR√âDICTION (accepte des coordonn√©es optionnelles) ---
    async function updatePredictionInternal(lat = null, lon = null) {
        const targetLat = lat !== null ? lat : userLat;
        const targetLon = lon !== null ? lon : userLon;
        try {
            const response = await fetch(`/api/tunisian_prediction?lat=${targetLat}&lon=${targetLon}&species=loup`);
            const data = await response.json();
            
            if(data.status === 'success') {
                currentPredictionData = data;
                
                let rawScore = data.scores?.final || 0;
                if(rawScore > 1000) rawScore = rawScore / 100;
                const score = Math.max(0, Math.min(100, Math.round(rawScore)));
                
                document.getElementById('prediction-score').textContent = `${score}%`;
                document.getElementById('header-prediction-score').textContent = `${score}%`;
                document.getElementById('check-score').textContent = `${score}%`;
                
                let text = '';
                if(score >= 85) text = 'Excellent ! Conditions optimales';
                else if(score >= 70) text = 'Bonnes conditions';
                else if(score >= 50) text = 'Conditions moyennes';
                else text = 'Conditions difficiles';
                
                document.getElementById('prediction-text').textContent = text;
                document.getElementById('header-prediction-text').textContent = text;
                
                if(data.scores) {
                    document.getElementById('mini-env-score').textContent = `${data.scores.environmental || '--'}%`;
                    document.getElementById('mini-beh-score').textContent = `${data.scores.behavioral || '--'}%`;
                    document.getElementById('detail-environmental').textContent = `${data.scores.environmental || '--'}%`;
                    document.getElementById('detail-behavioral').textContent = `${data.scores.behavioral || '--'}%`;
                }
                
                if(data.bathymetry) {
                    document.getElementById('mini-depth').textContent = `${data.bathymetry.depth || '--'} m`;
                    document.getElementById('mini-seabed').textContent = data.bathymetry.seabed_description || '--';
                    document.getElementById('detail-depth').textContent = `${data.bathymetry.depth || '--'} m`;
                    document.getElementById('detail-depth-optimal').textContent = data.bathymetry.optimal_for_species ? '‚úÖ Optimale' : '‚ö†Ô∏è Sous-optimale';
                    document.getElementById('detail-seabed').textContent = data.bathymetry.seabed_description || '--';
                }
                
                // Mise √† jour de la hauteur des vagues depuis la pr√©diction
                if (data.weather) {
                    let waveValue = 0.2;
                    if (data.weather.wave_height !== undefined && data.weather.wave_height !== null) {
                        waveValue = data.weather.wave_height;
                        updateWaveHeight(waveValue, 'pr√©diction API');
                    } else if (data.weather.wind_speed) {
                        waveValue = calculateWaveHeight(data.weather.wind_speed);
                        updateWaveHeight(waveValue, 'pr√©diction calcul√©e');
                    }
                }
                
                if(data.weather) {
                    document.getElementById('detail-wave-height').textContent = `${data.weather.wave_height?.toFixed(1) || '--'} m`;
                    document.getElementById('check-waves').textContent = `${data.weather.wave_height?.toFixed(1) || '--'} m`;
                    document.getElementById('wave-height').textContent = `${data.weather.wave_height?.toFixed(1) || '--'} m`;
                }
                
                if(data.scientific_factors?.tidal_current) {
                    const current = data.scientific_factors.tidal_current;
                    document.getElementById('detail-current').textContent = `${current.speed_mps?.toFixed(2) || '--'} m/s`;
                    document.getElementById('detail-current-impact').textContent = current.fishing_impact || '--';
                }
                
                updateFishCount(score);
            }
        } catch(error) {
            console.error('Erreur pr√©diction:', error);
        }
    }
    
    // --- DONN√âES SCIENTIFIQUES (accepte des coordonn√©es optionnelles) ---
    async function updateScientificDataInternal(lat = null, lon = null) {
        const targetLat = lat !== null ? lat : userLat;
        const targetLon = lon !== null ? lon : userLon;
        try {
            const response = await fetch(`/api/scientific_factors?lat=${targetLat}&lon=${targetLon}&species=loup`);
            const data = await response.json();
            
            if(data.status === 'success') {
                const factors = data.factors;
                
                document.getElementById('water-temp').textContent = factors.water_temperature?.value ? `${factors.water_temperature.value}¬∞C` : '--¬∞C';
                document.getElementById('oxygen-level').textContent = factors.dissolved_oxygen?.value ? `${factors.dissolved_oxygen.value} mg/L` : '-- mg/L';
                document.getElementById('phytoplankton').textContent = factors.chlorophyll_a?.value ? `${factors.chlorophyll_a.value} mg/m¬≥` : '--';
                document.getElementById('moon-phase').textContent = getCurrentMoonPhase();
            }
        } catch(error) {
            console.error('Erreur donn√©es scientifiques:', error);
            document.getElementById('water-temp').textContent = '22¬∞C';
            document.getElementById('oxygen-level').textContent = '7.2 mg/L';
            document.getElementById('phytoplankton').textContent = 'Moyenne';
            document.getElementById('moon-phase').textContent = getCurrentMoonPhase();
        }
    }
    
    // --- GRAPHIQUE ACTIVIT√â 24h (VERSION CORRIG√âE) ---
    async function load24hForecastInternal(lat = null, lon = null) {
        const targetLat = lat !== null ? lat : userLat;
        const targetLon = lon !== null ? lon : userLon;
        try {
            const response = await fetch(`/api/24h_forecast?lat=${targetLat}&lon=${targetLon}&species=loup`);
            const data = await response.json();
            
            if(data.status === 'success' && activityChart) {
                // Mettre √† jour le graphique
                activityChart.data.labels = data.hours || [];
                activityChart.data.datasets[0].data = data.scores || [];
                activityChart.update();
                
                // Mettre √† jour la tendance
                const trendEl = document.getElementById('current-trend');
                const trendArrow = document.getElementById('trend-arrow');
                if(trendEl && trendArrow) {
                    if(data.trend === 'rising') {
                        trendEl.textContent = 'Hausse';
                        trendArrow.textContent = '‚ÜóÔ∏è';
                    } else if(data.trend === 'falling') {
                        trendEl.textContent = 'Baisse';
                        trendArrow.textContent = '‚ÜòÔ∏è';
                    } else {
                        trendEl.textContent = 'Stable';
                        trendArrow.textContent = '‚û°Ô∏è';
                    }
                }
                
                // --- CORRECTION : Synchroniser le score affich√© avec l'API 24h ---
                if (data.current_score) {
                    document.getElementById('prediction-score').textContent = data.current_score + '%';
                    document.getElementById('header-prediction-score').textContent = data.current_score + '%';
                    document.getElementById('check-score').textContent = data.current_score + '%';
                }
                
                // --- MEILLEURE HEURE (sous le pictogramme) ---
                const bestPeriodEl = document.getElementById('best-period');
                if (bestPeriodEl && data.best_hour) {
                    let displayText = data.best_hour;
                    let emoji = '';
                    
                    if (data.best_hour.includes('maintenant')) {
                        emoji = ' üî•';
                    } else if (data.best_score >= 80) {
                        emoji = ' üî•';
                    } else if (data.best_score >= 60) {
                        emoji = ' üëç';
                    } else {
                        emoji = ' üëå';
                    }
                    
                    bestPeriodEl.innerHTML = `${displayText}${emoji} <span style="font-size:0.7rem; color:#94a3b8">${data.best_score}%</span>`;
                }
                
                // --- PROCHAINE FEN√äTRE ---
                const nextWindowStart = document.getElementById('next-window-start');
                const nextWindowEnd = document.getElementById('next-window-end');
                const windowQuality = document.getElementById('window-quality');
                
                if (nextWindowStart && data.best_time) {
                    nextWindowStart.textContent = data.best_time;
                    
                    if (data.best_hour.includes('maintenant')) {
                        nextWindowEnd.innerHTML = '<span style="color:#10b981; font-weight:bold;">üî• P√äCHEZ MAINTENANT !</span>';
                    } else {
                        // Calculer le compte √† rebours
                        const now = new Date();
                        const [hour, minute] = data.best_time.split(':').map(Number);
                        const bestTime = new Date(now);
                        bestTime.setHours(hour, minute, 0);
                        
                        if (bestTime < now) {
                            bestTime.setDate(bestTime.getDate() + 1);
                        }
                        
                        const diffMs = bestTime - now;
                        const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
                        const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                        
                        if (diffHrs > 0) {
                            nextWindowEnd.textContent = `dans ${diffHrs}h${diffMins > 0 ? diffMins : ''}`;
                        } else {
                            nextWindowEnd.textContent = `dans ${diffMins} min`;
                        }
                    }
                    
                    // Qualit√© avec emoji
                    let quality = 'moyenne';
                    let emoji = 'üëå';
                    if (data.best_score >= 80) {
                        quality = 'excellente';
                        emoji = 'üî•';
                    } else if (data.best_score >= 60) {
                        quality = 'bonne';
                        emoji = 'üëç';
                    }
                    
                    windowQuality.innerHTML = `${quality} ${emoji} <span style="font-size:0.7rem; color:#94a3b8">${data.best_score}%</span>`;
                }
                
                // Afficher une note si pr√©sente
                if (data.note) {
                    const oldNote = document.getElementById('forecast-note');
                    if (oldNote) oldNote.remove();
                    
                    const noteEl = document.createElement('div');
                    noteEl.id = 'forecast-note';
                    noteEl.style.cssText = 'margin-top:0.5rem; padding:0.75rem; background:#10b981; color:white; border-radius:6px; text-align:center; font-weight:bold; animation:pulse 2s infinite;';
                    noteEl.innerHTML = 'üî• ' + data.note + ' üî•';
                    
                    const chartContainer = document.querySelector('.chart-container');
                    if (chartContainer) {
                        chartContainer.parentNode.insertBefore(noteEl, chartContainer.nextSibling);
                    }
                }
                
                // Afficher les meilleurs cr√©neaux (optionnel)
                if(data.best_windows && data.best_windows.length > 0) {
                    const oldList = document.getElementById('periods-list');
                    if(oldList) oldList.remove();
                    
                    let periodsHtml = '<div id="periods-list" style="margin-top:1rem;padding:.5rem;background:#1e293b;border-radius:6px">';
                    periodsHtml += '<div style="color:#94a3b8;font-size:.8rem;margin-bottom:.5rem">üìã Meilleurs cr√©neaux :</div>';
                    
                    data.best_windows.slice(0, 3).forEach(p => {
                        let qualityEmoji = p.avg_score >= 80 ? 'üî•' : p.avg_score >= 60 ? 'üëç' : 'üëå';
                        periodsHtml += `
                            <div style="display:flex;justify-content:space-between;font-size:.9rem;padding:.25rem 0;border-bottom:1px solid #334155">
                                <span>${p.start} ‚Üí ${p.end}</span>
                                <span style="color:${p.avg_score >= 80 ? '#10b981' : '#f59e0b'}">
                                    ${qualityEmoji} ${p.avg_score}%
                                </span>
                            </div>
                        `;
                    });
                    
                    periodsHtml += '</div>';
                    
                    const chartContainer = document.querySelector('.chart-container');
                    if(chartContainer) {
                        const periodsDiv = document.createElement('div');
                        periodsDiv.innerHTML = periodsHtml;
                        chartContainer.parentNode.insertBefore(periodsDiv.firstChild, chartContainer.nextSibling);
                    }
                }
            }
        } catch(error) {
            console.error('Erreur pr√©visions 24h:', error);
        }
    }
    
    // --- UTILITAIRES ---
    function updateFishCount(score) {
        const fishCount = document.getElementById('current-fish-count');
        if(fishCount) {
            const estimated = Math.floor(score * 2.5);
            fishCount.textContent = estimated;
        }
    }
    
    function checkOffshoreWind(isOffshore) {
        const alertDiv = document.getElementById('wind-offshore-alert');
        const dangerDiv = document.getElementById('offshore-danger');
        const checkOffshore = document.getElementById('check-offshore');
        
        if(isOffshore === true) {
            if(alertDiv) {
                alertDiv.style.display = 'block';
                alertDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> <strong>VENT OFFSHORE - DANGER DE NOYADE</strong><br>Vent soufflant de la terre vers la mer - ${currentWindSpeed.toFixed(1)} km/h`;
            }
            if(dangerDiv) dangerDiv.style.display = 'block';
            if(checkOffshore) checkOffshore.textContent = '‚ö†Ô∏è';
        } else {
            if(alertDiv) alertDiv.style.display = 'none';
            if(dangerDiv) dangerDiv.style.display = 'none';
            if(checkOffshore) checkOffshore.textContent = '‚úÖ';
        }
    }
    
    function getCurrentMoonPhase() {
        const now = new Date();
        const daysInCycle = 29.530588853;
        const knownNewMoon = new Date(2024, 0, 11);
        const daysSince = (now - knownNewMoon) / (1000 * 60 * 60 * 24);
        const daysInCurrent = daysSince % daysInCycle;
        
        if(daysInCurrent < 1.84566) return 'Nouvelle Lune';
        if(daysInCurrent < 5.53699) return 'Premier Croissant';
        if(daysInCurrent < 9.22831) return 'Premier Quartier';
        if(daysInCurrent < 12.91963) return 'Gibbeuse Croissante';
        if(daysInCurrent < 16.61096) return 'Pleine Lune';
        if(daysInCurrent < 20.30228) return 'Gibbeuse D√©croissante';
        if(daysInCurrent < 23.99361) return 'Dernier Quartier';
        return 'Dernier Croissant';
    }
    
    function startValidityCountdown(minutes = 30) {
        let timeLeft = minutes * 60;
        const timer = setInterval(() => {
            timeLeft--;
            const mins = Math.floor(timeLeft / 60);
            const secs = timeLeft % 60;
            const countdown = document.getElementById('countdown');
            if(countdown) {
                countdown.textContent = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
                if(timeLeft <= 300) countdown.style.color = '#ef4444';
            }
            if(timeLeft <= 0) {
                clearInterval(timer);
                loadWeatherDataInternal();
                updatePredictionInternal();
                updateScientificDataInternal();
                load24hForecastInternal();
                startValidityCountdown(30);
            }
        }, 1000);
    }
    
    // --- SPOTS ---
    function addSpotToMap(spot, isCustom = false) {
        if(!spot || !spot.lat || !spot.lon) return;
        let iconColor = {port:'#3b82f6',plage:'#10b981',rocheux:'#f59e0b',custom:'#ef4444'}[spot.type] || '#6b7280';
        
        const icon = L.divIcon({
            html: `<div style="background:${iconColor};width:${isCustom?14:12}px;height:${isCustom?14:12}px;border-radius:50%;border:2px solid white;box-shadow:0 0 5px rgba(0,0,0,0.5);${isCustom?'animation:pulse 1.5s infinite':''}"></div>`,
            className: 'spot-icon',
            iconSize: [isCustom?18:16, isCustom?18:16]
        });
        
        const marker = L.marker([spot.lat, spot.lon], {icon}).addTo(map);
        
        let popupContent = `
            <div style="min-width:200px;">
                <h3 style="margin:0 0 5px;color:#1e40af">${spot.name}</h3>
                <span style="background:${iconColor};color:white;padding:2px 8px;border-radius:12px;font-size:12px">${isCustom?'Personnalis√©':spot.type}</span>
                <p style="margin:5px 0">${spot.description || ''}</p>
                <button onclick="window.FishingDashboard.selectSpot(${spot.lat},${spot.lon},'${spot.name.replace(/'/g,"\\'")}')" 
                        style="margin-top:10px;padding:5px 10px;background:#3b82f6;color:white;border:none;border-radius:4px;width:100%;margin-bottom:5px;">
                    <i class="fas fa-check"></i> S√©lectionner
                </button>
        `;
        
        if(isCustom) {
            popupContent += `
                <button onclick="window.FishingDashboard.deleteCustomSpot(${spot.lat},${spot.lon},'${spot.name.replace(/'/g,"\\'")}')" 
                        style="padding:5px 10px;background:#dc2626;color:white;border:none;border-radius:4px;width:100%;">
                    <i class="fas fa-trash"></i> Supprimer ce spot
                </button>
            `;
        }
        
        popupContent += `</div>`;
        marker.bindPopup(popupContent);
        marker.spotType = spot.type;
        marker.spotData = spot;
        marker.isCustom = isCustom;
    }
    
    function loadCustomSpots() {
        try {
            const saved = localStorage.getItem('fishingPredictorCustomSpots');
            if(saved) {
                customSpots = JSON.parse(saved);
                customSpots.forEach(s => addSpotToMap(s, true));
            }
        } catch(e) { console.error('Erreur chargement spots:', e); customSpots = []; }
    }
    
    function saveCustomSpots() {
        localStorage.setItem('fishingPredictorCustomSpots', JSON.stringify(customSpots));
    }
    
    // ========== API PUBLIQUE ==========
    return {
        // Initialisation
        initMap() {
            if(!document.getElementById('map')) return;
            map = L.map('map').setView([userLat, userLon], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution:'¬© OpenStreetMap'
            }).addTo(map);
            
            loadCustomSpots();
            TUNISIAN_SPOTS.forEach(s => addSpotToMap(s, false));
            
            currentMarker = L.marker([userLat, userLon], {
                icon: L.divIcon({
                    html: '<div style="background:#3b82f6;width:16px;height:16px;border-radius:50%;border:3px solid white;box-shadow:0 0 10px rgba(59,130,246,0.7);"></div>',
                    className: 'user-location-icon',
                    iconSize: [22, 22]
                })
            }).addTo(map).bindPopup('Votre position actuelle');
            
            map.on('click', (e) => {
                const name = prompt("Nom du spot :", "Mon spot");
                if(name) {
                    const newSpot = {
                        name, lat: e.latlng.lat, lon: e.latlng.lng,
                        type: "custom", depth: "?", description: "Spot personnalis√©"
                    };
                    addSpotToMap(newSpot, true);
                    customSpots.push(newSpot);
                    saveCustomSpots();
                    this.showNotification(`Spot "${name}" ajout√© !`, 'success');
                }
            });
            
            initWindAnimation();
            
            const ctx = document.getElementById('activity-chart');
            if(ctx) {
                activityChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels: [], datasets: [{
                        label: 'Activit√© (%)',
                        data: [],
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59,130,246,0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 3
                    }]},
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8', maxTicksLimit: 8 } },
                            y: { beginAtZero: true, max: 100, grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: '#94a3b8', stepSize: 20 } }
                        }
                    }
                });
            }
            
            loadWeatherDataInternal();
            updateScientificDataInternal();
            load24hForecastInternal();
            startValidityCountdown(30);
            
            const now = new Date();
            document.getElementById('check-hour').textContent = `${now.getHours()}h`;
            
            setInterval(() => {
                if(document.visibilityState === 'visible') {
                    loadWeatherDataInternal();
                    updatePredictionInternal();
                    updateScientificDataInternal();
                    load24hForecastInternal();
                }
            }, 5 * 60000);
        },
        
        // VENT - Activation/d√©sactivation
        toggleWindAnimation(e) {
            windAnimationActive = !windAnimationActive;
            const canvas = document.getElementById('wind-animation-canvas');
            const btn = e?.currentTarget || document.getElementById('windToggleBtn');
            
            if(windAnimationActive) {
                canvas.style.display = 'block';
                if(btn) {
                    btn.innerHTML = '<i class="fas fa-wind"></i> Masquer vent';
                    btn.classList.add('btn-primary');
                    btn.classList.remove('btn-secondary');
                }
                initWindParticles();
                animateWind();
                console.log(`üå™Ô∏è Animation vent activ√©e - Direction: ${currentWindDirection}¬∞, Vitesse: ${currentWindSpeed} km/h`);
            } else {
                canvas.style.display = 'none';
                if(btn) {
                    btn.innerHTML = '<i class="fas fa-wind"></i> Afficher vent';
                    btn.classList.add('btn-secondary');
                    btn.classList.remove('btn-primary');
                }
                if(windAnimationFrame) cancelAnimationFrame(windAnimationFrame);
            }
        },
        
        toggleSpotType(type) {
            const isChecked = event?.target?.checked || false;
            if(map) map.eachLayer(layer => { if(layer.spotType === type) layer.setOpacity(isChecked ? 1 : 0); });
        },
        
        // S√âLECTION SPOT (expos√©e publiquement)
        selectSpot(lat, lon, name) {
            return selectSpot(lat, lon, name);
        },
        
        // CALCUL DISTANCE (expos√©e publiquement)
        calculateDistanceToSpot(lat, lon) {
            return calculateDistanceToSpot(lat, lon);
        },
        
        // GESTION DES SPOTS PERSONNALIS√âS
        deleteCustomSpot(lat, lon, name) {
            if(confirm(`Voulez-vous vraiment supprimer le spot "${name}" ?`)) {
                customSpots = customSpots.filter(spot => 
                    !(Math.abs(spot.lat - lat) < 0.0001 && Math.abs(spot.lon - lon) < 0.0001)
                );
                saveCustomSpots();
                this.reloadMap();
                this.showNotification(`Spot "${name}" supprim√©`, 'success');
            }
        },
        
        clearCustomSpots() {
            if(confirm("‚ö†Ô∏è Voulez-vous vraiment supprimer TOUS vos spots personnalis√©s ?\nCette action est irr√©versible.")) {
                customSpots = [];
                saveCustomSpots();
                this.reloadMap();
                this.showNotification('Tous vos spots ont √©t√© supprim√©s', 'info');
            }
        },
        
        reloadMap() {
            if(!map) return;
            
            const center = map.getCenter();
            const zoom = map.getZoom();
            
            map.eachLayer((layer) => {
                if(layer instanceof L.Marker && layer !== currentMarker) {
                    map.removeLayer(layer);
                }
            });
            
            TUNISIAN_SPOTS.forEach(s => addSpotToMap(s, false));
            customSpots.forEach(s => addSpotToMap(s, true));
            
            map.setView(center, zoom);
        },
        
        // Actions
        getCurrentLocation() {
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        updateUserPosition(pos.coords.latitude, pos.coords.longitude);
                        this.showNotification('Position mise √† jour !', 'success');
                    },
                    (err) => {
                        console.error('Erreur g√©olocalisation:', err);
                        this.showNotification('Impossible d\'obtenir votre position', 'error');
                    }
                );
            } else {
                this.showNotification('G√©olocalisation non support√©e', 'error');
            }
        },
        
        saveCurrentSpot() {
            if(selectedSpot) {
                const name = prompt("Nom du spot :", `Spot ${selectedSpot.lat.toFixed(4)},${selectedSpot.lon.toFixed(4)}`);
                if(name) {
                    const newSpot = {
                        name, lat: selectedSpot.lat, lon: selectedSpot.lon,
                        type: "custom", depth: "?", description: "Spot sauvegard√©"
                    };
                    fetch('/api/save_spot', {
                        method:'POST', headers:{'Content-Type':'application/json'},
                        body:JSON.stringify(newSpot)
                    }).then(r=>r.json()).then(d=>{
                        if(d.status === 'success') {
                            customSpots.push(newSpot);
                            saveCustomSpots();
                            addSpotToMap(newSpot, true);
                            this.showNotification(`Spot "${name}" sauvegard√© !`, 'success');
                        }
                    }).catch(e=>this.showNotification("Erreur sauvegarde", 'error'));
                }
            } else {
                this.showNotification("S√©lectionnez d'abord un spot", 'error');
            }
        },
        
        calculatePreparationTime() {
            this.showNotification('‚è±Ô∏è Pr√©paration: 45 min ‚Ä¢ D√©part dans 10 min', 'info');
        },
        
        quickCheck() {
            this.checkGoNowDecision();
            this.showNotification('V√©rification effectu√©e !', 'info');
            if('vibrate' in navigator) navigator.vibrate(100);
        },
        
        async checkGoNowDecision() {
            try {
                const r = await fetch(`/api/quick_check?lat=${userLat}&lon=${userLon}`);
                const d = await r.json();
                if(d.status === 'success') {
                    const banner = document.getElementById('instant-decision-banner');
                    if(banner) {
                        banner.innerHTML = `
                            <div style="background:${d.color};color:white;padding:1rem;border-radius:8px;display:flex;align-items:center;gap:1rem">
                                <i class="fas fa-${d.decision==='danger'?'skull-crossbones':d.decision==='excellent'?'check-circle':'thumbs-up'}" style="font-size:1.5rem"></i>
                                <div style="font-weight:700;flex:1">${d.message}</div>
                                <button onclick="this.parentElement.remove()" style="background:rgba(255,255,255,.2);border:none;color:white;padding:.5rem;border-radius:4px;cursor:pointer">√ó</button>
                            </div>
                        `;
                    }
                }
            } catch(e) { console.error(e); }
        },
        
        toggleDetailedAnalysis() {
            const mini = document.getElementById('detailed-analysis-mini');
            const full = document.getElementById('detailed-analysis-full');
            const btn = event?.currentTarget;
            if(mini.style.display === 'none') {
                mini.style.display = 'grid';
                full.style.display = 'none';
                if(btn) btn.innerHTML = '<i class="fas fa-chevron-down"></i> Voir';
            } else {
                mini.style.display = 'none';
                full.style.display = 'block';
                if(btn) btn.innerHTML = '<i class="fas fa-chevron-up"></i> R√©duire';
                if(currentPredictionData) this.updateDetailedAnalysis(currentPredictionData);
            }
        },
        
        updateDetailedAnalysis(data) {
            if(!data) return;
            document.getElementById('detail-environmental').textContent = `${data.scores?.environmental || '--'}%`;
            document.getElementById('detail-behavioral').textContent = `${data.scores?.behavioral || '--'}%`;
            if(data.bathymetry) {
                document.getElementById('detail-depth').textContent = `${data.bathymetry.depth || '--'} m`;
                document.getElementById('detail-depth-optimal').textContent = data.bathymetry.optimal_for_species ? '‚úÖ Optimale' : '‚ö†Ô∏è Sous-optimale';
                document.getElementById('detail-seabed').textContent = data.bathymetry.seabed_description || '--';
            }
            if(data.weather) {
                document.getElementById('detail-wave-height').textContent = `${data.weather.wave_height?.toFixed(1) || '--'} m`;
            }
            if(data.scientific_factors?.tidal_current) {
                const c = data.scientific_factors.tidal_current;
                document.getElementById('detail-current').textContent = `${c.speed_mps?.toFixed(2) || '--'} m/s`;
                document.getElementById('detail-current-impact').textContent = c.fishing_impact || '--';
            }
        },
        
        showNotification(message, type = 'info') {
            const notif = document.createElement('div');
            notif.style.cssText = `position:fixed;top:20px;right:20px;padding:1rem 1.5rem;background:${type==='success'?'#10b981':type==='error'?'#ef4444':'#3b82f6'};color:white;border-radius:8px;z-index:9999;animation:slideIn .3s;max-width:300px`;
            notif.innerHTML = `<div style="display:flex;align-items:center;gap:10px"><i class="fas fa-${type==='success'?'check-circle':type==='error'?'exclamation-circle':'info-circle'}"></i>${message}</div>`;
            document.body.appendChild(notif);
            setTimeout(() => {
                notif.style.animation = 'slideOut .3s';
                setTimeout(() => notif.remove(), 300);
            }, 5000);
        },
        
        // M√©thodes de compatibilit√©
        addWindAnimation: function() { 
            if(!windAnimationActive) this.toggleWindAnimation();
        },
        removeWindAnimation: function() {
            if(windAnimationActive) this.toggleWindAnimation();
        },
        updateWindAnimation: function() {
            if(windAnimationActive) {
                initWindParticles();
            }
        },
        
        // M√©thodes d'export
        refreshWeather: loadWeatherDataInternal,
        refreshPrediction: updatePredictionInternal,
        refreshScientific: updateScientificDataInternal,
        refreshForecast: load24hForecastInternal,
        
        getCurrentWindInfo() {
            return {
                speed: currentWindSpeed,
                direction: currentWindDirection,
                animationActive: windAnimationActive,
                animationAngle: (currentWindDirection + 90) % 360
            };
        }
    };
})();

// Initialisation
document.addEventListener('DOMContentLoaded', () => FishingDashboard.initMap());

// Export global
window.FishingDashboard = FishingDashboard;
window.getCurrentLocation = () => FishingDashboard.getCurrentLocation();
window.quickCheck = () => FishingDashboard.quickCheck();
window.toggleWindLayer = (e) => FishingDashboard.toggleWindAnimation(e);
window.toggleSpotType = (t) => FishingDashboard.toggleSpotType(t);
</script>
{% endblock %}